{% extends "base.html" %}
{% load difftags %}
{% load djblets_deco %}
{% load i18n %}
{% load reviewtags %}

{% block title %}{{review_request_details.summary}} | {% trans "Diff Viewer" %}{% endblock %}
{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}rb/css/diffviewer.css" />
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}rb/css/reviews.css" />
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}rb/css/syntax.css" />
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}rb/css/yui-ui.css" />
<script type="text/javascript" src="{{MEDIA_URL}}yui/utilities/utilities.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}yui-ext/yui-ext.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}rb/scripts/rb/common.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}rb/scripts/rb/dialogs.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}rb/scripts/rb/widgets.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}rb/scripts/comments.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}rb/scripts/diffviewer.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}rb/scripts/reviews.js"></script>
<script type="text/javascript">
  var gReviewRequestPath = '{{review_request.get_absolute_url}}';
  var gReviewRequestId = '{{review_request.id}}';
  var gRevision = '{{diffset.revision}}';
{% if interdiffset %}
  var gInterdiffRevision = '{{interdiffset.revision}}';
{% else %}
  var gInterdiffRevision = null;
{% endif %}
  var gUserAuthenticated = {{user.is_authenticated|lower}};
</script>
{% endblock %}

{% block content %}
{% if error %}
{% errorbox %}
 <p>{{error}}</p>
 {% if trace %}<pre>{{trace|escape}}</pre>{% endif %}
{% enderrorbox %}
{% else %}

{% ifneatnumber review_request.id %}
{%  box "yay" %}
 <img src="{{MEDIA_URL}}rb/images/{% if milestone %}trophy{% else %}fish-trophy{% endif %}.png" width="32" height="48" border="0" alt="" />
 <h1>{% firstof review_request.submitter.get_full_name review_request.submitter.username %} got review request #{{review_request.id}}!</h1>
{%  endbox %}
{% endifneatnumber %}

{% include "reviews/review_header.html" %}

{% box "review-request" %}
<ul id="topcontrols">
 <li><a href="{{review_request.get_absolute_url}}"><img src="{{MEDIA_URL}}rb/images/reviewrequest.png" width="16" height="16" border="0" alt="" /> {% trans "View Review Request" %}</a></li>
</ul>
<div class="main">
{% include "reviews/review_request_box.html" %}

<div id="diff-details">
<a name="index_header"></a>
{% with review_request.diffset_history.diffset_set.latest.revision as latest_revision %}
{% with diffset.revision as revision %}
<div class="main">
{%  if interdiffset %}
{#   We're showing an interdiff, so indicate the revision range. #}
 <h1>{% blocktrans with interdiffset.revision as interdiff_revision %}Changes between revision {{revision}} and {{interdiff_revision}}{% endblocktrans %}</h1>
{%  else %}
{%   ifequal diffset.revision latest_revision %}
 <h1>{% blocktrans %}Diff revision {{revision}} (Latest){% endblocktrans %}</h1>
{%   else %}
{#    This is not the most recent diff. See if we're showing a draft. #}
{%    if is_draft_diff %}
 <h1>{% trans "Draft diff" %}</h1>
 <p>
{%     blocktrans %}
  This diff is part of your current draft. Other users will not see this
  diff until you publish your draft.
{%     endblocktrans %}
{%    else %}
{#     This is not a draft. Tell the user this is not the most recent. #}
 <h1>{% blocktrans %}Diff revision {{revision}}{% endblocktrans %}</h1>
 <p>
{%     blocktrans with diffset.revision as revision and review_request.get_absolute_url as review_request_url%}
  This is not the most recent revision of the diff. The
  <a href="{{review_request_url}}diff/">latest diff</a> is revision
  {{latest_revision}}.
  <a href="{{review_request_url}}diff/{{revision}}-{{latest_revision}}/">See what's changed.</a>
{%     endblocktrans %}
{%    endif %}
 </p>
{%   endifequal %}
{%  endif %}

{#  Notify the user if they have unpublished comments in other diffs. #}
{%  if review|has_comments_in_diffsets_excluding:diffset_pair %}
{%   box "important" %}
 <h1>{% trans "You have unpublished comments on other revisions" %}</h1>
 <p>
  {% trans "Your review consists of comments on the following revisions:" %}
 </p>
 <ul>
{%    for diffset_info in review|diffsets_with_comments:diffset_pair %}
{%     if diffset_info.is_current %}
  <li><b>Revision {{diffset_info.diffset.revision}}</b></li>
{%     else %}
  <li><a href="{{review_request.get_absolute_url}}diff/{{diffset_info.diffset.revision}}/#index_header">Revision {{diffset_info.diffset.revision}}</a></li>
{%     endif %}
{%    endfor %}
{%    for pair in review|interdiffs_with_comments:diffset_pair %}
{%     if pair.is_current %}
  <li><b>Interdiff revision {{pair.diffset.revision}} - {{pair.interdiff.revision}}</b></li>
{%     else %}
  <li><a href="{{review_request.get_absolute_url}}diff/{{pair.diffset.revision}}-{{pair.interdiff.revision}}/">Interdiff revision {{pair.diffset.revision}} - {{pair.interdiff.revision}}</a></li>
{%     endif %}
{%    endfor %}
 </ul>
 {%  endbox %}
{%  endif %}

{%  ifnotequal review_request.diffset_history.diffset_set.count 1 %}
{#   Show a revision selector for jumping between revisions. #}
 <table class="revision-selector">
  <tr>
   <th><label for="jump_to_revision">{% trans "Jump to revision:" %}<label></th>
   <td>
    <div id="jump_to_revision" class="revisions">
{%  for item in review_request.diffset_history|revision_link_list:diffset_pair %}
{%   if item.is_current %}
     <span class="current">{{item.revision}}</span>
{%   else %}
     <a href="{{review_request.get_absolute_url}}diff/{{item.revision}}/#index_header">{{item.revision}}</a>
{%   endif %}
{%  endfor %}
{%  if draft and draft.diffset %}
{#   There's a draft diff, so display it in the list. #}
{%   if is_draft_diff %}
     <span class="current">{{draft.diffset.revision}}</span>
{%   else %}
     <a href="{{review_request.get_absolute_url}}diff/{{draft.diffset.revision}}/#index_header">{{draft.diffset.revision}}</a>
{%   endif %}
{%  endif %}
    </div>
   </td>
  </tr>
  <tr>
   <th><label for="show_interdiff">{% blocktrans %}Changes between r{{revision}} and:{% endblocktrans %}</label></th>
   <td>
    <div id="show_interdiff" class="revisions">
{%  for item in review_request.diffset_history|interdiff_link_list:diffset_pair %}
{%   if item.is_current %}
     <span class="current">{{item.revision}}</span>
{%   else %}
     <a href="{{review_request.get_absolute_url}}diff/{{item.path}}/#index_header">{{item.revision}}</a>
{%   endif %}
{%  endfor %}
{%  if draft and draft.diffset %}
{#   There's a draft diff, so display it in the list. #}
{%   if is_draft_diff or is_draft_interdiff %}
     <span class="current">{{draft.diffset.revision}}</span>
{%   else %}
     <a href="{{review_request.get_absolute_url}}diff/{{diffset_pair.0}}-{{diffset_pair.1}}/#index_header">{{draft.diffset.revision}}</a>
{%   endif %}
{%  endif %}
    </div>
   </td>
  </tr>
 </table>
{% endifnotequal %}

 <p><label>{% trans "Files Changed:" %}</label></p>
{% include "diffviewer/changeindex.html" %}
  </div>
 </div>
</div>

<ul class="controls">
{% if user.is_authenticated %}<li><a href="#" onClick="showReviewDlg();" id="review-link">{% trans "Review" %}</a></li>{% endif %}
 <li><a href="raw/"> {% trans "Download Patch" %}</a></li>
{% if collapseall %}
 <li><a href=".?expand=1"><img src="{{MEDIA_URL}}rb/images/expand.png" width="14" height="14" border="0" alt="" /> {% trans "Expand changes" %}</a></li>
{% else %}
 <li><a href=".?collapse=1"><img src="{{MEDIA_URL}}rb/images/collapse.png" width="14" height="14" border="0" alt="" /> {% trans "Collapse changes" %}</a></li>
{% endif %}
</ul>
{% endwith %}
{% endwith %}
{%  endbox %}

<div id="diffs">
{% for file in files %}
<a name="{{file.index}}"></a>
{{ file.fragment }}
<script type="text/javascript">
  gFileAnchorToId["file{{file.filediff.id}}"] = {{file.filediff.id}};
{% if file.interfilediff %}
  gInterdiffFileAnchorToId["file{{file.filediff.id}}"] = {{file.interfilediff.id}};
{% endif %}
  addComments("file{{file.filediff.id}}", {% commentcounts file.filediff file.interfilediff %});
</script>
{% endfor %}
<a name="index_footer"></a>
{% include "diffviewer/changeindex.html" %}
</div>

{% include "diffviewer/comments_dlg.html" %}

{% endif %}
{% endblock %}
