{% extends "base.html" %}
{% load difftags %}
{% load htmlutils %}
{% load reviewtags %}

{% block title %}{{review_request_details.summary}} | Review Request{% endblock %}
{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/css/diffviewer.css" />
<link rel="stylesheet" type="text/css" href="/css/reviews.css" />
<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
<link rel="stylesheet" type="text/css" href="/css/yui-ui.css" />
<script type="text/javascript" src="/scripts/yui/yahoo/yahoo-min.js"></script>
<script type="text/javascript" src="/scripts/yui/animation/animation-min.js"></script>
<script type="text/javascript" src="/scripts/yui/connection/connection-min.js"></script>
<script type="text/javascript" src="/scripts/yui/event/event-min.js"></script>
<script type="text/javascript" src="/scripts/yui/dom/dom-min.js"></script>
<script type="text/javascript" src="/scripts/yui/utilities/utilities.js"></script>
<script type="text/javascript" src="/scripts/yui-ext/yui-ext.js"></script>
<script type="text/javascript" src="/scripts/rb/core.js"></script>
<script type="text/javascript" src="/scripts/rb/dialogs.js"></script>
<script type="text/javascript" src="/scripts/rb/widgets.js"></script>
<script type="text/javascript" src="/scripts/reviews.js"></script>
<script type="text/javascript">
var gUserURL = "{{user.get_absolute_url}}";
var gUserFullName = "{% firstof user.get_full_name user.username %}";
var gReviewRequestId = "{{review_request.id}}";
var gBugTrackerURL = "{{review_request.repository.bug_tracker}}";
</script>
{% endblock %}

{% block content %}
{% ifneatnumber review_request.id %}
{%  box "yay" %}
 <img src="/images/{% if milestone %}trophy{% else %}fish-trophy{% endif %}.png" width="32" height="48" border="0" alt="" />
 <h1>{% firstof review_request.submitter.get_full_name review_request.submitter.username %} got review request #{{review_request.id}}!</h1>
{%  endbox %}
{% endifneatnumber %}
<div class="banner" id="error"></div>
<div class="banner" id="main-banner"></div>

{% box "review-request" %}
<ul id="topcontrols">
{% if review_request_details.diffset or review_request.diffset_history.diffset_set.count %}
 <li onclick="javascript:window.location='diff/#index_header';"><a href="diff/#index_header"><img src="/images/diff.png" width="17" height="14" border="0" alt="" /> View Diff</a></li>
{% endif %}
</ul>
{% include "reviews/review_request_box.html" %}
{% endbox %}

{% for review in reviews %}
<a name="review{{review.id}}"></a>
{% if forloop.last %}
<a name="last-review" />
{% endif %}
{% box "review" %}
<div class="main">
 <div class="banner" id="{{review.id}}-banner"></div>
 <div class="header">
  {% if review.ship_it %}<div class="shipit">Ship it!</div>{% endif %}
  <div class="reviewer"><a href="{{review.user.get_absolute_url}}">{% firstof review.user.get_full_name review.user.username %}</a></div>
  <div class="posted_time">Posted {{review.timestamp|timesince}} ago</div>
 </div>
 <div class="body">
  {% if review.body_top %}
   <pre class="body_top">{{review.body_top|escape}}</pre>
   {% reply_section review "" "body_top" "rcbt" %}
  {% endif %}
{% if review.comments.all or review.screenshot_comments.all %}
   <dl class="diff-comments">
{% for comment in review.screenshot_comments.all %}
    <dt>
     <span class="filename">
      Screenshot:
      <a href="{{comment.screenshot.get_absolute_url}}">{% if comment.screenshot.caption %}{{comment.screenshot.caption}}{% else %}{{comment.screenshot.image|basename}}{% endif %}</a>
     </span>
    </dt>
    <dd>
     <pre>{{comment.text|escape}}</pre>
         {% reply_section review comment "screenshot_comment" "rc" %}
    </dd>
{% endfor %}
{% for comment in review.ordered_comments %}
    <dt>
     <table class="sidebyside">
      <colgroup>
       <col class="line" />
       <col class="left" />
       <col class="right" />
      </colgroup>
      <thead>
       <tr>
        <th colspan="3" class="filename">
         <a href="diff/{{review.reviewed_diffset.revision}}">{{comment.filediff.dest_file}}</a>
{% ifequal comment.first_line comment.last_line %}
         line <a href="diff/{{review.reviewed_diffset.revision}}/#file{{comment.filediff.id}}line{{comment.first_line}}">{{comment.first_line}}</a>
{% else %}
         lines <a href="diff/{{review.reviewed_diffset.revision}}/#file{{comment.filediff.id}}line{{comment.first_line}}">{{comment.first_line}}</a> - <b>{{comment.last_line}}</b>
{% endifequal %}
        </th>
       </tr>
      </thead>
{% forchunkswithlines comment.filediff comment.first_line comment.num_lines %}
      <tbody class="{{chunk.change}}">
{% for line in chunk.lines %}
       <tr>
        <th>{{line.0}}</td>
        <td><pre>{{ line.1|highlightregion:line.2|showextrawhitespace }}</pre></td>
        <td><pre>{{ line.3|highlightregion:line.4|showextrawhitespace }}</pre></td>
       </tr>
{% endfor %}
      </tbody>
{% endforchunkswithlines %}
     </table>
    </dt>
    <dd>
     <pre>{{comment.text|escape}}</pre>
	 {% reply_section review comment "comment" "rc" %}
    </dd>
{% endfor %}
   </dl>
{% endif %}
  {% if review.body_bottom %}
   <pre class="body_bottom">{{review.body_bottom|escape}}</pre>
   {% reply_section review "" "body_bottom" "rcbb" %}
  {% endif %}
 </div>
</div>
{% endbox %}
{% endfor %}

{% ifequal request.user review_request.submitter %}
<script type="text/javascript">
  registerEditor('summary', false);
  registerEditor('branch', false);
  registerEditor('description', true);
  registerEditor('testing_done', true);
  registerCommaListEditor('bugs_closed', onBugsChanged);
  registerCommaListEditor('target_groups', onTargetGroupsChanged);
  registerCommaListEditor('target_people', onTargetPeopleChanged);

{% for image in review_request_details.screenshots.all %}
  registerEditor('screenshot_{{image.id}}_caption', false);
{% endfor %}

{% if draft %}
  showDraftBanner();
{% else %}
  hideDraftBanner();
{% endif %}
</script>
{% endifequal %}
{% endblock %}
