{% extends "base.html" %}
{% block title %}Review Request | {{details}}{% endblock %}
{% block extrahead %}
<script type="text/javascript" src="/scripts/prototype.js"></script>
<script type="text/javascript" src="/scripts/scriptaculous.js"></script>
{% endblock %}

{% block content %}
<div id="servererror"></div>

<div id="banner">
</div>
<table id="review-details">
 <tr>
  <td colspan="2"><span id="summary">{{details.summary}}</span> <img id="summary_edit" src="/images/edit.png" width="14" height="14" /></td>
  <td id="updated_time">Last updated {{details.last_updated|timesince}} ago</td>
 </tr>
 <tr>
  <td class="label"><label for="submitter">Submitter:</label></td>
  <td class="value" id="submitter"><a href="{{details.submitter.get_absolute_url}}">{{details.submitter}}</a></td>
  <td id="status">{{details.get_status_display}}</td>
 </tr>
 <tr>
  <td class="label"><label for="branch">Branch:</label></td>
  <td class="value"><span id="branch">{{details.branch}}</span> <img id="branch_edit" src="/images/edit.png" width="14" height="14" /></td>
  <td id="viewdiff"><a href="{{details.htmldiff}}">View diff</a></td>
 </tr>
{% ifnotequal details.target_groups.count 0 %}
 <tr>
  <td class="label"><label for="target_groups">Group reviewers:</label></td>
  <td class="value" colspan="2"><span id="target_groups">
{%  for group in details.target_groups.all %}
<a href="{{group.get_absolute_url}}">{{group}}</a>{%if not forloop.last %}, {%endif %}
{%  endfor %}
  </span> <img id="target_groups_edit" src="/images/edit.png" width="14" height="14" /></td>
 </tr>
{% endifnotequal %}
{% ifnotequal details.target_people.count 0 %}
 <tr>
  <td class="label"><label for="target_people">Individual reviewers:</label></td>
  <td class="value" colspan="2"><span id="target_people">
{%  for person in details.target_people.all %}
<a href="{{person.get_absolute_url}}">{{person}}</a>{%if not forloop.last %}, {%endif %}
{%  endfor %}
  </span> <img id="target_people_edit" src="/images/edit.png" width="14" height="14" /></td>
 </tr>
{% endifnotequal %}
{% if details.bugs_closed %}
 <tr>
  <td class="label"><label for="bugs_closed">Bugs Closed:</label></td>
  <td class="value" colspan="2"><span id="bugs_closed">
{%  for bug in details.get_bug_list %}
   <a href="http://bugzilla/show_bug.cgi?id={{bug}}">{{bug}}</a>{%if not forloop.last %}, {%endif %}
{%  endfor %}
  </span> <img id="bugs_closed_edit" src="/images/edit.png" width="14" height="14" /></td>
 </tr>
{% endif %}
 <tr>
  <td class="vertlabel" colspan="3"><label for="description">Description:</label></td>
 </tr>
 <tr>
  <td colspan="3"><pre><div id="description">{{details.description|escape}}</div></pre></td>
 </tr>
 <tr>
  <td class="vertlabel" colspan="3"><label for="testing_done">Testing Done:</label></td>
 </tr>
 <tr>
  <td colspan="3"><pre><div id="testing_done">{{details.testing_done|escape}}</div></pre></td>
 </tr>
</table>

<script type="text/javascript">
	function onSubmitFailure(transport) {
		$('servererror').innerHTML = transport.responseText;
	}

	function onSubmitComplete(transport, element) {
		//new Effect.Highlight(element,
		//	{startcolor: transport.options.highlightcolor});
		showDraftBanner();
	}

	function registerEditor(field) {
		new Ajax.InPlaceEditor(field, 'field/' + field + '/',
		                       {externalControl: field + '_edit',
							    onFailure: onSubmitFailure,
								onComplete: onSubmitComplete});
	}

	function registerMultiEditor(field) {
		new Ajax.InPlaceEditor(field, 'field/' + field + '/',
		                       {externalControl: field + '_edit',
							    rows: 10, cols: 80,
							    onFailure: onSubmitFailure,
								onComplete: onSubmitComplete});
	}

	function showDraftBanner() {
		if ($('draft') == null) {
			$('banner').appendChild(
				Builder.node('div', {id: 'draft'}, [
					Builder.node("h1", "This is a draft."),
					" Be sure to save when finished.",
					Builder.node('input', {type: 'submit', value: 'Save',
										   onClick: 'submitDraft();'}),
					Builder.node('input', {type: 'submit', value: 'Revert',
										   onClick: 'revertDraft();'})
				])
			);
		}
	}

	function hideDraftBanner() {
		var node = $('draft');

		if (node != null) {
			$('banner').removeChild(node);
		}
	}

	registerEditor('summary');
	registerEditor('branch');
	registerMultiEditor('description');
	registerMultiEditor('testing_done');
	registerEditor('bugs_closed');
	registerEditor('target_groups');
	registerEditor('target_people');

	if ({% ifequal draft None %}0{% else %}1{% endifequal %}) {
		showDraftBanner();
	} else {
		hideDraftBanner();
	}

</script>
{% endblock %}
