{% extends "base.html" %}
{% load difftags %}
{% load htmlutils %}
{% load reviewtags %}

{% block title %}Review Request | {{details}}{% endblock %}
{% block extrahead %}
<script type="text/javascript" src="/scripts/yui/yahoo/yahoo-min.js"></script>
<script type="text/javascript" src="/scripts/yui/animation/animation-min.js"></script>
<script type="text/javascript" src="/scripts/yui/connection/connection-min.js"></script>
<script type="text/javascript" src="/scripts/yui/event/event-min.js"></script>
<script type="text/javascript" src="/scripts/yui/dom/dom-min.js"></script>
<script type="text/javascript" src="/scripts/yui-ext/yui-ext.js"></script>
<script type="text/javascript" src="/scripts/rb/core.js"></script>
<script type="text/javascript" src="/scripts/rb/widgets.js"></script>
<script type="text/javascript" src="/scripts/reviews.js"></script>
<script type="text/javascript">
var gUserURL = "{{user.get_absolute_url}}";
var gUserFullName = "{% firstof user.get_full_name user.username %}";
var gReviewRequestId = "{{object.id}}";
var gBugTrackerURL = "{{object.repository.bug_tracker}}";
</script>
{% endblock %}

{% block content %}
<div class="banner" id="error"></div>
<div class="banner" id="main-banner"></div>

{% box review-request %}
<ul id="topcontrols">
{% if details.diffset or object.diffset_history.diffset_set.count %}
 <li onclick="javascript:window.location='diff/';"><a href="diff/"><img src="/images/diff.png" width="17" height="14" border="0" alt="" /> View Diff</a></li>
{% endif %}
</ul>
<div class="main">
 <div class="header">
  <div id="summary_wrapper"><h1 id="summary">{{details.summary}}</h1></div>
  <p id="status">
   {{object.get_status_display}}<br />
   Updated {{details.last_updated|timesince}} ago
  </p>
 </div>
 <table id="details">
  <colgroup>
   <col width="0%" />
   <col width="50%" />
  </colgroup>
  <colgroup>
   <col width="0%" />
   <col width="50%" />
  </colgroup>
  <tr>
   <td class="label"><label for="submitter">Submitter:</label></td>
   <td class="value"><a id="submitter" href="{{object.submitter.get_absolute_url}}">{% firstof object.submitter.get_full_name object.submitter.username %}</a></td>
   <td class="caption" colspan="2">Reviewers</td>
  </tr>
  <tr>
   <td class="label"><label for="branch">Branch:</label></td>
   <td class="value"><span id="branch">{{details.branch}}</span></td>
   <td class="indented label"><label for="target_groups">Groups:</label></td>
   <td class="value"><span id="target_groups">
{%  for group in details.target_groups.all %}
<a href="{{group.get_absolute_url}}">{{group}}</a>{%if not forloop.last %}, {%endif %}
{%  endfor %}
  </span></td>
  </tr>
  <tr>
   <td class="label"><label for="bugs_closed">Bugs Closed:</label></td>
   <td class="value"><span id="bugs_closed">
{%  for bug in details.get_bug_list %}
{%   if object.repository.bug_tracker %}<a href={{bug|bug_url:object}}>{{bug}}</a>{% else %}{{bug}}{% endif %}{% if not forloop.last %}, {% endif %}
{%  endfor %}
  </span></td>
   <td class="indented label"><label for="target_people">People:</label></td>
   <td class="value"><span id="target_people">
{%  for person in details.target_people.all %}
<a href="{{person.get_absolute_url}}">{{person}}</a>{%if not forloop.last %}, {%endif %}
{%  endfor %}
  </span></td>
  </tr>
  <tr>
   <td class="label"><label for="changenum">Change Number:</label></td>
   <td class="value"><span id="changenum">{{object.changenum}}</span></td>
   <td class="label"><label for="repository">Repository:</label></td>
   <td class="value"><span id="repository">{{object.repository}}</span></td>
  </tr>
 </table>
 <div class="content">
  <label for="description">Description:</label>
  <pre id="description">{{details.description|escape}}</pre>
 </div>
 <div class="content">
  <label for="testing_done">Testing Done:</label>
  <pre id="testing_done">{{details.testing_done|escape}}</pre>
 </div>
 {% if details.screenshots.count %}
 <div class="content clearfix">
  <label for="images">Screenshots:</label>
  {% for image in details.screenshots.all %}
   <div class="screenshot-container">
    <a href="{{image.get_absolute_url}}"><img src="{{image.image|thumbnail}}" alt="{{image.caption}}" /></a><br />
    <div class="screenshot-caption">
     <a href="{{image.get_absolute_url}}" id="screenshot_{{image.id}}_caption">{{image.caption}}</a>
     {% ifequal request.user object.submitter %}
      <a href="s/{{image.id}}/delete/"><img src="/images/delete.png" alt="Delete Screenshot" /></a>
     {% endifequal %}
    </div>
   </div>
  {% endfor %}
 </div>
 {% endif %}
</div>
<ul class="controls">
{% ifequal request.user object.submitter %}
{%  if details.public %}
{%    ifequal details.status 'P' %}
 <li><a href="submitted/">Set Submitted</a></li>
 <li><a href="#" onClick="showDiscardBanner();">Discard</a></li>
{%    else %}
 <li><a href="reopen/">Reopen for Review</a></li>
{%    endifequal %}
{%  else %}
 <li><a href="#" onClick="publishDraft();">Publish</a></li>
 <li><a href="#" onClick="showDiscardBanner();">Discard</a></li>
{%  endif %}
 <li><a href="diff/upload/?repositoryid={{object.repository.id}}"><img src="/images/upload.png" width="14" height="14" border="0" alt="" /> Upload Diff</a></li>
 <li><a href="s/upload/"><img src="/images/upload.png" width="14" height="14" border="0" alt="" /> Upload Screenshot</a></li>
{% endifequal %}
{% ifequal request.user object.submitter %}
 <noscript><li><a href="edit/"><img src="/images/edit.png" width="14" height="14" border="0" alt="" /> Edit</a></li></noscript>
{% endifequal %}
</ul>
{% endbox %}

{% for review in reviews %}
<a name="review{{review.id}}"></a>
{% box review %}
<div class="main">
 <div class="banner" id="{{review.id}}-banner"></div>
 <div class="header">
  {% if review.ship_it %}<div class="shipit">Ship it!</div>{% endif %}
  <div class="reviewer"><a href="{{review.user.get_absolute_url}}">{% firstof review.user.get_full_name review.user.username %}</a></div>
  <div class="posted_time">Posted {{review.timestamp|timesince}} ago</div>
 </div>
 <div class="body">
  <pre class="body_top">{{review.body_top}}</pre>
  {% reply_section review "" "body_top" "rcbt" %}
{% if review.comments.all or review.screenshot_comments.all %}
   <dl class="diff-comments">
{% for comment in review.screenshot_comments.all %}
    <dt>
     <span class="filename">
      Screenshot:
      <a href="{{comment.screenshot.get_absolute_url}}">{% if comment.screenshot.caption %}{{comment.screenshot.caption}}{% else %}{{comment.screenshot.image|basename}}{% endif %}</a>
     </span>
    </dt>
    <dd>
     <pre>{{comment.text|escape}}</pre>
         {% reply_section review comment "screenshot_comment" "rc" %}
    </dd>
{% endfor %}
{% for comment in review.comments.all %}
    <dt>
     <table class="sidebyside">
      <colgroup>
       <col class="line" />
       <col class="left" />
       <col class="right" />
      </colgroup>
      <thead>
       <tr>
        <th colspan="3" class="filename">
         <a href="diff/{{review.reviewed_diffset.revision}}">{{comment.filediff.dest_file}}</a>
{% ifequal comment.first_line comment.last_line %}
         line <a href="diff/{{review.reviewed_diffset.revision}}/#file{{comment.filediff.id}}line{{comment.first_line}}">{{comment.first_line}}</a>
{% else %}
         lines <a href="diff/{{review.reviewed_diffset.revision}}/#file{{comment.filediff.id}}line{{comment.first_line}}">{{comment.first_line}}</a> - <b>{{comment.last_line}}</b>
{% endifequal %}
        </th>
       </tr>
      </thead>
{% forchunkswithlines comment.filediff comment.first_line comment.num_lines %}
      <tbody class="{{chunk.change}}">
{% for line in chunk.lines %}
       <tr>
        <th>{{line.0}}</td>
        <td><pre>{{ line.1|highlightregion:line.2|showextrawhitespace }}</pre></td>
        <td><pre>{{ line.3|highlightregion:line.4|showextrawhitespace }}</pre></td>
       </tr>
{% endfor %}
      </tbody>
{% endforchunkswithlines %}
     </table>
    </dt>
    <dd>
     <pre>{{comment.text|escape}}</pre>
	 {% reply_section review comment "comment" "rc" %}
    </dd>
{% endfor %}
   </dl>
{% endif %}
  <pre class="body_bottom">{{review.body_bottom}}</pre>
  {% reply_section review "" "body_bottom" "rcbb" %}
 </div>
</div>
{% endbox %}
{% endfor %}

{% ifequal request.user object.submitter %}
<script type="text/javascript">
  registerEditor('summary', false, false);
  registerEditor('branch', false, false);
  registerEditor('description', true, false);
  registerEditor('testing_done', true, false);
  registerCommaListEditor('bugs_closed', onBugsChanged);
  registerCommaListEditor('target_groups', onTargetGroupsChanged);
  registerCommaListEditor('target_people', onTargetPeopleChanged);

{% for image in details.screenshots.all %}
  registerEditor('screenshot_{{image.id}}_caption', false);
{% endfor %}

{% if draft %}
  showDraftBanner();
{% else %}
  hideDraftBanner();
{% endif %}
</script>
{% endifequal %}
{% endblock %}
