#summary Working with fixtures for unit tests
#labels Phase-Implementation

= Overview =

Fixtures in Django are essentially dumps of part of the database. They contain data for the various models and can be loaded in automatically for unit tests. This makes it quite easy for us to have various sets of data to test against.

For our tests, we currently have three sets of fixtures:

  # accounts/fixtures/test_users.json - accounts/auth apps
  # reviews/fixtures/test_reviewrequests.json - diffviewer/reviews apps
  # scmtools/fixtures/test_scmtools.json - scmtools app

Detailed information on what's contained in these fixtures is below.

= Updating Fixtures =

If you're going to add to the existing fixtures, you'll first want to modify settings_local.py and set your database to be sqlite. Then:

{{{
$ ./manage.py syncdb
$ ./manage.py loaddata test_users test_scmtools test_reviewrequests
}}}

This should populate your database with the test data. After you've added to the data set, dump them back out:

{{{
$ ./manage.py dumpdata auth accounts > accounts/fixtures/test_users.json
$ ./manage.py dumpdata diffviewer reviews > reviews/fixtures/test_reviewrequests.json
$ ./manage.py dumpdata scmtools > scmtools/fixtures/test_scmtools.json
}}}

You can choose to only dump the data you've actually modified. If you've only created a review request, for example, feel free to just dump the diffviewer and reviews apps.


= Using Fixtures in Tests =

Using fixtures in tests is really easy. In your test class (which must be derived from `django.test.TestCase`), add a `fixtures = [...]` line listing the fixtures you intend to use. For example:

{{{
class MyTests(TestCase):
    fixtures = ['test_users', 'test_reviewrequests', 'test_scmtools']

    ...
}}}

Note that there are some dependencies to remember. `"test_users"` can be included by itself, as can `"test_scmtools"`, but if you want to use `"test_reviewrequests"`, you must include both `"test_users"` and `"test_scmtools"`.

= Fixture Details =

== test_users.json ==

=== User entries ===

==== admin ====

  * *username:* "admin"
  * *password:* "admin"
  * *first_name:* "Admin"
  * *last_name:* "User"
  * *email:* "admin@example.com"
  * *is_staff:* True
  * *is_superuser:* True

==== doc ====

  * *username:* "doc"
  * *password:* "doc"
  * *first_name:* "Doc"
  * *last_name:* "Dwarf"
  * *email:* "doc@example.com"
  * *permissions:* ['reviews.can_change_status']

==== dopey ====

  * *username:* "dopey"
  * *password:* "dopey"
  * *first_name:* "Dopey"
  * *last_name:* "Dwarf"
  * *email:* "dopey@example.com"

==== grumpy ====

  * *username:* "grumpy"
  * *password:* "grumpy"
  * *first_name:* "Grumpy"
  * *last_name:* "Dwarf"
  * *email:* "grumpy@example.com"

== test_reviewrequests.json ==

=== Group entries ===

==== devgroup ====

  * *name:* "devgroup"
  * *mailing_list:* "devgroup@example.com"
  * *users:* ['doc', 'dopey']

==== newgroup ====

  * *name:* "newgroup"
  * *mailing_list:* "newgroup@example.com"
  * *users:* []

==== emptygroup ====

  * *name:* "emptygroup"
  * *mailing_list:* ""
  * *users:* []

==== privgroup ====

  * *name:* "privgroup"
  * *mailing_list:* ""
  * *users:* ['doc', 'dopey', 'grumpy']

=== ReviewRequest entries ===

==== Added interdiff support ====

  * *submitter:* "doc"
  * *summary:* "Added interdiff support"
  * *description:* ""
  * *testing_done:* ""
  * *target_groups:* []
  * *target_people:* ['doc']
  * *bugs_closed:* ['']
  * *status:* "D"
  * *diff:* "interdiffs.diff"
  * *reviews:* []

==== Made e-mail improvements ====

  * *submitter:* "grumpy"
  * *summary:* "Made e-mail improvements"
  * *description:* "Test description."
  * *testing_done:* "Tested."
  * *target_groups:* []
  * *target_people:* ['doc']
  * *bugs_closed:* ['12345']
  * *status:* "P"
  * *diff:* "email_improvements.diff"
  * *reviews:* []

==== Improved login form ====

  * *submitter:* "doc"
  * *summary:* "Improved login form"
  * *description:* ""
  * *testing_done:* ""
  * *target_groups:* []
  * *target_people:* ['admin', 'doc']
  * *bugs_closed:* ['']
  * *status:* "S"
  * *diff:* "improved-login-form.diff"
  * *reviews:* []

==== Error dialog ====

  * *submitter:* "dopey"
  * *summary:* "Error dialog"
  * *description:* "Foo"
  * *testing_done:* "Bar"
  * *target_groups:* ['emptygroup']
  * *target_people:* []
  * *bugs_closed:* ['']
  * *status:* "P"
  * *diff:* "error-output-dlg.diff"
  * *reviews:* []

==== Update for cleaned_data changes ====

  * *submitter:* "dopey"
  * *summary:* "Update for cleaned_data changes"
  * *description:* "Be compatible with cleaned_data changes in Django."
  * *testing_done:* "Works."
  * *target_groups:* ['devgroup']
  * *target_people:* []
  * *bugs_closed:* ['123']
  * *status:* "P"
  * *diff:* "cleaned_data.diff"
  * *reviews:*
    * *"doc"*
      * *user:* "doc"
      * *ship_it:* True
      * *body_top:* "Looks fine."

==== Comments Improvements ====

  * *submitter:* "doc"
  * *summary:* "Comments Improvements"
  * *description:* ""
  * *testing_done:* ""
  * *target_groups:* ['devgroup']
  * *target_people:* []
  * *bugs_closed:* ['']
  * *status:* "P"
  * *diff:* "comments.diff"
  * *reviews:* []

==== Add permission checking for JSON API ====

  * *submitter:* "admin"
  * *summary:* "Add permission checking for JSON API"
  * *description:* "Added some user permissions checking for JSON API functions."
  * *testing_done:* "Tested some functions."
  * *target_groups:* ['privgroup']
  * *target_people:* ['doc', 'dopey']
  * *bugs_closed:* ['1234', ' 5678', ' 8765', ' 4321']
  * *status:* "P"
  * *diff:* "delete_review_req_permissions.diff"
  * *reviews:*
    * *"doc"*
      * *user:* "doc"
      * *body_top:* "Test"
      * *comments:*
        * *"Sample comment."*
          * *text:* "Sample comment."
          * *first_line:* 333
          * *num_lines:* 9
          * *file:* "/trunk/reviewboard/reviews/json.py"
    * *"dopey"*
      * *user:* "dopey"
      * *comments:*
        * *"Generic reply"*
          * *text:* "Generic reply"
          * *first_line:* 333
          * *num_lines:* 9
          * *file:* "/trunk/reviewboard/reviews/json.py"
    * *"dopey"*
      * *user:* "dopey"
      * *comments:*
        * *"Sample comment 1"*
          * *text:* "Sample comment 1"
          * *first_line:* 433
          * *num_lines:* 1
          * *file:* "/trunk/reviewboard/htdocs/scripts/reviews.js"
        * *"Sample comment 2"*
          * *text:* "Sample comment 2"
          * *first_line:* 449
          * *num_lines:* 1
          * *file:* "/trunk/reviewboard/htdocs/scripts/reviews.js"
    * *"grumpy"*
      * *user:* "grumpy"
      * *body_top:* "Grumpy body"
    * *"dopey"*
      * *user:* "dopey"
      * *body_top:* "Dopey reply"
    * *"grumpy"*
      * *user:* "grumpy"
      * *body_top:* "Grumpy reply"

== test_scmtools.json ==

=== Repository entries ===

==== Review Board SVN ====

  * *name:* "Review Board SVN"
  * *path:* "http://reviewboard.googlecode.com/svn"
  * *bug_tracker:* "http://code.google.com/p/reviewboard/issues/detail?id=%s"
  * *tool:* "Subversion"

==== Navi SVN ====

  * *name:* "Navi SVN"
  * *path:* "http://svn.navi.cx/misc"
  * *bug_tracker:* ""
  * *tool:* "Subversion"