{% extends "base.html" %}
{% block title %}Diff Viewer{% endblock %}
{% block extrahead %}
<script type="text/javascript" src="/scripts/prototype.js"></script>
{% endblock %}

{% block content %}
<script language="javascript">
// Constants
var BACKWARD = -1;
var FORWARD  = 1;
var INVALID  = -1;
var DIFF_SCROLLDOWN_AMOUNT = 100;

var gActions = [
	{ // Previous file
		keys: "aAKP<m",
		onPress: function() { scrollToAnchor(GetNextFileAnchor(BACKWARD)); }
	},

	{ // Next file
		keys: "fFJN>/",
		onPress: function() { scrollToAnchor(GetNextFileAnchor(FORWARD)); }
	},

	{ // Previous diff
		keys: "sSkp,,",
		onPress: function() { scrollToAnchor(GetNextAnchor(BACKWARD)); }
	},

	{ // Next diff
		keys: "dDjn..",
		onPress: function() { scrollToAnchor(GetNextAnchor(FORWARD)); }
	},

	{ // Recenter
		keys: unescape("%0D"),
		onPress: function() { scrollToAnchor(gSelectedAnchor); }
	},

	{ // Go to header
		keys: "gu;",
		onPress: function() {}
	},

	{ // Go to footer
		keys: "GU:",
		onPress: function() {}
	},
];

// State variables
var gSelectedAnchor = INVALID;
var gCurrentAnchor = 0;

Event.observe(window, 'load', onPageLoaded, false);

function keyCode(evt) {
	if (navigator.appName.indexOf("Explorer") != -1) {
		return evt.keyCode;
	} else {
		return evt.which;
	}
}

function onKeyPress(evt) {
	var keyChar = String.fromCharCode(keyCode(evt));

	for (var i = 0; i < gActions.length; i++) {
		if (gActions[i].keys.indexOf(keyChar) != -1) {
			gActions[i].onPress();
			return;
		}
	}
}

function gotoAnchor(name) {
	return scrollToAnchor(GetAnchorByName(name));
}

function GetAnchorByName(name) {
	for (var anchor = 0; anchor < document.anchors.length; anchor++) {
		if (document.anchors[anchor].name == name) {
			return anchor;
		}
	}

	return INVALID;
}

function onPageLoaded(evt) {
	/* Skip over the change index to the first item */
	gSelectedAnchor = 1;
	SetHighlighted(gSelectedAnchor, true)

	Event.observe(window, 'keypress', onKeyPress, false);
}

function scrollToAnchor(anchor) {
	if (anchor == INVALID) {
		return false;
	}

	window.scrollTo(0,
		GetYPos(document.anchors[anchor]) - DIFF_SCROLLDOWN_AMOUNT);
	SetHighlighted(gSelectedAnchor, false);
	SetHighlighted(anchor, true);
	gSelectedAnchor = anchor;

	return true;
}

function GetYPos(obj) {
	return obj.offsetTop + (obj.offsetParent ? GetYPos(obj.offsetParent) : 0);
}

function GetNextAnchor(dir) {
	var newAnchor = gSelectedAnchor + dir;
	if (newAnchor < 0 || newAnchor >= document.anchors.length) {
		return INVALID;
	}

	var name = document.anchors[newAnchor].name;

	if (name == "index_header" || name == "index_footer") {
		return INVALID;
	}

	return newAnchor;
}

function GetNextFileAnchor(dir) {
	var fileId = document.anchors[gSelectedAnchor].name.split(".")[0];
	var newAnchor = parseInt(fileId) + dir;
	return GetAnchorByName(newAnchor);
}

function SetHighlighted(anchor, highlighted) {
	var anchorNode = document.anchors[anchor];
	var node = anchorNode.parentNode;
	var nextNode = anchorNode.nextSibling.nextSibling;
	var controlsNode;

	if (node.tagName == "TD" || node.tagName == "TH") {
		node = node.parentNode;
		controlsNode = node.getElementsByTagName('td')[0].firstChild;
	}
	else if (nextNode.className == "sidebyside") {
		node = nextNode.getElementsByTagName('tr')[0];
		controlsNode = node.getElementsByTagName('th')[0].firstChild;
	}
	else {
		return;
	}

	if (highlighted) {
		Element.addClassName(node, "selected");
		controlsNode.nodeValue = "â–¶";
	} else {
		Element.removeClassName(node, "selected");
		controlsNode.nodeValue = "";
	}
}
</script>

<div id="diffs">
{% if error %}
 {{ error }}
 {% if trace %}<pre>{{ trace }}</pre>{% endif %}
{% else %}
<a name="index_header"></a>
{% include "diffviewer/changeindex.html" %}

{% for file in files %}
<a name="{{file.index}}"></a>
<table class="sidebyside">
 <colgroup>
  <col class="controls" />
  <col class="left" width="50%" />
  <col class="right" width="50%" />
 </colgroup>
 <thead>
  <tr onClick="gotoAnchor('{{file.index}}');">
   <th class="controls">&nbsp;</th>
   <th>{{ file.depot_filename }} ({{file.revision}})</th>
   <th>{{ file.user_filename }}</th>
  </tr>
 </thead>
 <tbody>
{% for chunk in file.chunks %}
  <tr{% ifnotequal chunk.change "equal" %} class="{{chunk.change}}" onClick="gotoAnchor('{{file.index}}.{{chunk.index}}');"{% endifnotequal %}>
   <td class="controls">&nbsp;</td>
   <td>{% ifnotequal chunk.index None %}<a name="{{file.index}}.{{chunk.index}}"></a>{% endifnotequal %}<pre>{{ chunk.oldtext|escape }}</pre></td>
   <td><pre>{{ chunk.newtext|escape }}</pre></td>
  </tr>
{% endfor %}
 </tbody>
</table></li>
{% endfor %}
<a name="index_footer"></a>
{% include "diffviewer/changeindex.html" %}
{% endif %}
</div>
{% endblock %}
