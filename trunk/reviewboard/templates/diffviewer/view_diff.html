{% extends "base.html" %}
{% load i18n %}
{% load difftags %}
{% load reviewtags %}
{% load htmlutils %}

{% block title %}{{review_request_details.summary}} | {% trans "Diff Viewer" %}{% endblock %}
{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/css/diffviewer.css" />
<link rel="stylesheet" type="text/css" href="/css/reviews.css" />
<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
<script type="text/javascript" src="/scripts/yui/utilities/utilities.js"></script>
<script type="text/javascript" src="/scripts/yui-ext/yui-ext.js"></script>
<script type="text/javascript" src="/scripts/rb/common.js"></script>
<script type="text/javascript" src="/scripts/rb/dialogs.js"></script>
<script type="text/javascript" src="/scripts/rb/widgets.js"></script>
<script type="text/javascript" src="/scripts/comments.js"></script>
<script type="text/javascript" src="/scripts/diffviewer.js"></script>
<script type="text/javascript" src="/scripts/reviews.js"></script>
<link rel="stylesheet" type="text/css" href="/css/yui-ui.css" />
<script type="text/javascript">
  var gReviewRequestPath = '{{review_request.get_absolute_url}}';
  var gReviewRequestId = '{{review_request.id}}';
  var gRevision = '{{diffset.revision}}';
{% if interdiffset %}
  var gInterdiffRevision = '{{interdiffset.revision}}';
{% else %}
  var gInterdiffRevision = null;
{% endif %}
  var gUserAuthenticated = {{user.is_authenticated|lower}};
</script>
{% endblock %}

{% block content %}
{% if error %}
{% errorbox %}
 <p>{{error}}</p>
 {% if trace %}<pre>{{trace|escape}}</pre>{% endif %}
{% enderrorbox %}
{% else %}

{% ifneatnumber review_request.id %}
{%  box "yay" %}
 <img src="/images/{% if milestone %}trophy{% else %}fish-trophy{% endif %}.png" width="32" height="48" border="0" alt="" />
 <h1>{% firstof review_request.submitter.get_full_name review_request.submitter.username %} got review request #{{review_request.id}}!</h1>
{%  endbox %}
{% endifneatnumber %}

{% box "review-request" %}
<ul id="topcontrols">
 <li onclick="javascript:window.location='{{review_request.get_absolute_url}}';"><a href="{{review_request.get_absolute_url}}"><img src="/images/reviewrequest.png" width="16" height="16" border="0" alt="" /> View Review Request</a></li>
</ul>
<div class="main">
{% include "reviews/review_request_box.html" %}

<div id="diff-details">
<a name="index_header"></a>
{% with review_request.diffset_history.diffset_set.latest.revision as latest_revision %}
{% with diffset.revision as revision %}
<div class="main">
{%  if interdiffset %}
 <h1>{% blocktrans with interdiffset.revision as interdiff_revision %}Changes between revision {{revision}} and {{interdiff_revision}}{% endblocktrans %}</h1>
{%  else %}
{%   ifequal diffset.revision latest_revision %}
 <h1>{% blocktrans %}Diff revision {{revision}} (Latest){% endblocktrans %}</h1>
{%   else %}
 <h1>{% blocktrans %}Diff revision {{revision}}{% endblocktrans %}</h1>
 <p>
{%    blocktrans with diffset.revision as revision and review_request.get_absolute_url as review_request_url%}
  This is not the most recent revision of the diff. The
  <a href="{{review_request_url}}diff/">latest diff</a> is revision
  {{latest_revision}}.
  <a href="{{review_request_url}}diff/{{revision}}-{{latest_revision}}/">See what's changed.</a>
{%    endblocktrans %}
 </p>
{%   endifequal %}
{%  endif %}
{%  if review|has_comments_in_diffsets_excluding:diffset_pair %}
{%   box "important" %}
 <h1>{% trans "You have unpublished comments on other revisions" %}</h1>
 <p>
  {% trans "Your review consists of comments on the following revisions:" %}
 </p>
 <ul>
{%    for diffset_info in review|diffsets_with_comments:diffset_pair %}
{%     if diffset_info.is_current %}
  <li><b>Revision {{diffset_info.diffset.revision}}</b></li>
{%     else %}
  <li><a href="{{review_request.get_absolute_url}}diff/{{diffset_info.diffset.revision}}/#index_header">Revision {{diffset_info.diffset.revision}}</a></li>
{%     endif %}
{%    endfor %}
{%    for pair in review|interdiffs_with_comments:diffset_pair %}
{%     if pair.is_current %}
  <li><b>Interdiff revision {{pair.diffset.revision}} - {{pair.interdiff.revision}}</b></li>
{%     else %}
  <li><a href="{{review_request.get_absolute_url}}diff/{{pair.diffset.revision}}-{{pair.interdiff.revision}}/">Interdiff revision {{pair.diffset.revision}} - {{pair.interdiff.revision}}</a></li>
{%     endif %}
{%    endfor %}
 </ul>
 {%  endbox %}
{%  endif %}

{%  ifnotequal review_request.diffset_history.diffset_set.count 1 %}
 <table class="revision-selector">
  <tr>
   <th><label for="jump_to_revision">Jump to revision:<label></th>
   <td>
    <div id="jump_to_revision" class="paginator">
{%  for item in review_request.diffset_history|revision_link_list:diffset_pair %}
{%   if item.is_current %}
     <span class="current-page">{{item.revision}}</span>
{%   else %}
     <a href="{{review_request.get_absolute_url}}diff/{{item.revision}}/#index_header">{{item.revision}}</a>
{%   endif %}
{%  endfor %}
    </div>
   </td>
  </tr>
  <tr>
   <th><label for="show_interdiff">Changes between r{{revision}} and:</label></th>
   <td>
    <div id="show_interdiff" class="paginator">
{%  for item in review_request.diffset_history|interdiff_link_list:diffset_pair %}
{%   if item.is_current %}
     <span class="current-page">{{item.revision}}</span>
{%   else %}
     <a href="{{review_request.get_absolute_url}}diff/{{item.path}}/#index_header">{{item.revision}}</a>
{%   endif %}
{%  endfor %}
    </div>
   </td>
  </tr>
 </table>
{% endifnotequal %}

 <p><label>Files Changed:</label></p>
{% include "diffviewer/changeindex.html" %}
  </div>
 </div>
</div>

<ul class="controls">
 <li><a href="#" onClick="showReviewDlg();" id="review-link">{% trans "Review" %}</a></li>
 <li><a href="raw/"> {% trans "Download Patch" %}</a></li>
{% if collapseall %}
 <li><a href=".?expand=1"><img src="/images/expand.png" width="14" height="14" border="0" alt="" /> {% trans "Expand changes" %}</a></li>
{% else %}
 <li><a href=".?collapse=1"><img src="/images/collapse.png" width="14" height="14" border="0" alt="" /> {% trans "Collapse changes" %}</a></li>
{% endif %}
</ul>
{% endwith %}
{% endwith %}
{%  endbox %}

<div id="diffs">
{% for file in files %}
<a name="{{file.index}}"></a>
{{ file.fragment }}
<script type="text/javascript">
  gFileAnchorToId["file{{file.index}}"] = {{file.filediff.id}};
{% if file.interfilediff %}
  gInterdiffFileAnchorToId["file{{file.index}}"] = {{file.interfilediff.id}};
{% endif %}
  addComments("file{{file.index}}", {% commentcounts file.filediff file.interfilediff %});
</script>
{% endfor %}
<a name="index_footer"></a>
{% include "diffviewer/changeindex.html" %}
</div>

<div id="comment-dlg" style="visibility:hidden;position:absolute;top:0px;">
 <div class="ydlg-hd">{% trans "Comments" %}</div>
 <div class="ydlg-bd">
  <div id="tab-comments" class="ydlg-tab" title="{% trans "Comments" %}">
   <div id="existing-comments"></div>
   <form id="commentform" class="comment draft" method="post" action="comments/">
	<input type="hidden" name="action" id="id_comment_action" value="" />
	<input type="hidden" name="num_lines" id="id_num_lines" value="" />
    <label id="id_comment_label" for="id_comment">Your comment:</label><br />
	<textarea id="id_comment" name="text" rows="4" cols="20"></textarea>
   </form>
  </div>
 </div>
 <div id="tab-review" class="ydlg-tab" title="{% trans "Review" %}">
  <form id="reviewform" method="post">
   <input type="hidden" name="diff_revision" value="{{diffset.revision}}" />
{% if interdiffset %}
   <input type="hidden" name="interdiff_revision" value="{{interdiffset.revision}}" />
{% endif %}
   <input id="id_shipit" type="checkbox" name="shipit" value="shipit" {% if review and review.shipit %}checked="checked" {% endif %}/>{% trans "Ship It!" %}<br />
   <label for="id_body_top">{% trans "Review Body:" %}</label>
   <div id="review-body">
    <textarea id="id_body_top" name="body_top" rows="5" cols="20">{% if review %}{{review.body_top|escape}}{% endif %}</textarea>
    <div id="all-review-comments"><i>{% trans "Comments will be displayed here" %}</i></div>
    <textarea id="id_body_bottom" name="body_bottom" rows="5" cols="20">{% if review %}{{review.body_bottom|escape}}{% endif %}</textarea>
   </div>
  </form>
 </div>
</div>
{% endif %}
{% endblock %}
